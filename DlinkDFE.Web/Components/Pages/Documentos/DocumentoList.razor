@page "/documentos"
@inherits DocumentoListBase

<MudContainer Class="pt-8" Width="100%">
    <MudContainer Class="pa-4" Style="background-color: #f5f5f5; border-radius: 8px;">
        <MudContainer Class="pb-4">
        <MudStack Row="true">
            <MudItem xs="12" md="6">
                <MudTextField 
                    Style="width: 100%;"
                    @bind-Value="_searchString" 
                    Placeholder="Pesquisar..." 
                    Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.Search" 
                    Immediate="true">
                </MudTextField>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="string"
                    Placeholder="Status"
                    Variant="Variant.Outlined"
                    AnchorOrigin="Origin.BottomCenter" 
                    TransformOrigin="Origin.TopCenter"
                    MultiSelection="true"
                    SelectedValues="@_selectedStatuses"
                    MultiSelectionTextFunc="@(selectedItems => selectedItems.Any() ? string.Join(", ", selectedItems) : "Status")"
                    CloseMenuOnItemClick="false">
                    @foreach (var status in _statusOptions)
                    {
                        <MudSelectItem T="string" Value="@status">@status</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudSelect T="string"
                    Placeholder="Modelo"
                    Variant="Variant.Outlined"
                    AnchorOrigin="Origin.BottomCenter" 
                    TransformOrigin="Origin.TopCenter"
                    MultiSelection="true"
                    SelectedValues="@_selectedModels">
                    @foreach (var model in _modelOptions)
                    {
                        <MudSelectItem T="string" Value="@model">@model</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6" Class="pt-2">
                <MudMenu 
                    Label="Número de NF"
                    ActivationEvent="MouseEvent.LeftClick"
                    AnchorOrigin="Origin.BottomCenter" 
                    TransformOrigin="Origin.TopCenter"
                    Variant="Variant.Outlined">
                    <MudContainer Class="pt-4">                             
                        <MudNumericField HideSpinButtons="true" 
                                         @bind-Value="ValorInicial" 
                                         Label="Número inicial" 
                                         Variant="Variant.Text" 
                                         Min="0" 
                                         Max="50" />
                        <MudNumericField HideSpinButtons="true" 
                                         @bind-Value="ValorFinal" 
                                         Label="Número final" 
                                         Variant="Variant.Text" 
                                         Min="0" 
                                         Max="50" />
                    </MudContainer>
                </MudMenu>
            </MudItem>

            <MudItem xs="12" md="6" Class="pt-2">
                <MudButton Variant="Variant.Filled" OnClick="ResetFilters">Limpar Filtros</MudButton>
            </MudItem>
        </MudStack>
        <MudButton OnClick="OnExpandCollapseClick" EndIcon="@(_expanded ? Icons.Material.Filled.ArrowDropUp : Icons.Material.Filled.ArrowDropDown)">
    @(_expanded ? "Menos filtros" : "Mais filtros")
        </MudButton>

        </MudContainer>
    

        <MudDivider />

        <MudStack Row="true" Class="pt-4">

            <MudCollapse Expanded="_expanded">              
                <MudItem xs="12" Class="d-flex">
                    <MudContainer>
                        <MudContainer Class="pt-2">
                            <MudTextField @bind-Value="CNPJ_CPF" Placeholder="CNPJ/CPF" Variant="Variant.Outlined"></MudTextField>
                        </MudContainer>
                    </MudContainer>

                    <MudContainer>
                        <MudContainer>  
                            <MudContainer Class="pt-2">
                                <MudSelect T="string"
                                    Placeholder="Status"
                                    Variant="Variant.Outlined"
                                    AnchorOrigin="Origin.BottomCenter" 
                                    TransformOrigin="Origin.TopCenter"
                                    MultiSelection="true"
                                    SelectedValues="@_selectedStatuses"
                                    MultiSelectionTextFunc="@(selectedItems => selectedItems.Count == 0 ? "Status" : $"{selectedItems.Count} selecionado(s)")"
                                    CloseMenuOnItemClick="false"
                                    Class="mt-0">
                                    @foreach (var status in _statusOptions)
                                    {
                                        <MudSelectItem T="string" Value="@status">@status</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudContainer>

                            <MudSpacer />
                            
                            <MudContainer Class="pt-2">
                                <MudSelect T="string"
                                    Placeholder="Modelo"
                                    Variant="Variant.Outlined"
                                    Class="mt-0"
                                    MultiSelection="true"
                                    AnchorOrigin="Origin.BottomCenter" 
                                    TransformOrigin="Origin.TopCenter"
                                    SelectedValues="@_selectedModels">
                                    @foreach (var model in _modelOptions)
                                    {
                                        <MudSelectItem T="string" Value="@model">@model</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudContainer>                        
                        </MudContainer>
                        
                    </MudContainer>


                    <MudItem xs="12" Class="pb-2">

                        <MudContainer Class="pa-4">                             
                            <MudNumericField HideSpinButtons="true" 
                                            @bind-Value="ValorInicial" 
                                            Label="Número inicial" 
                                            Variant="Variant.Text" 
                                            Min="0" 
                                            Max="50" />
                            <MudNumericField HideSpinButtons="true" 
                                            @bind-Value="ValorFinal" 
                                            Label="Número final" 
                                            Variant="Variant.Text" 
                                            Min="0" 
                                            Max="50" />
                        </MudContainer>
                    </MudItem>

                    <MudSpacer />
                    
                    <MudContainer>

                        <MudContainer Class="d-flex">
                            <MudItem>
                                <MudRadioGroup @bind-Value="EmissaoOuAutorizacao">
                                <MudRadio Color="Color.Primary" Value="@("1")">Emissão</MudRadio>
                                <MudRadio Color="Color.Primary" Value="@("2")">Autorização</MudRadio>

                                </MudRadioGroup>

                            </MudItem>
                        </MudContainer>


                        <MudContainer Class="d-flex pt-2">
                            <MudItem>
                                <MudDatePicker Label="Data Inicial" @bind-Date="_initialDate" ShowToolbar="false" />
                                <MudDatePicker Label="Data Final" @bind-Date="_finalDate" ShowToolbar="false" />
                            </MudItem>
                        </MudContainer>
                    </MudContainer>

                </MudItem>
            </MudCollapse>
        </MudStack>
    </MudContainer>

    <MudDataGrid Class="pa-2"
                 T="Documento" 
                 Items="@FilteredDocumentos" 
                 MultiSelection="true" 
                 Filterable="true" 
                 SortMode="SortMode.Multiple">
        <Columns>
            <SelectColumn T="Documento" />
            <PropertyColumn Property="x => x.Status" Title="Status" />
            <PropertyColumn Property="x => x.Modelo" Title="Modelo" />
            <PropertyColumn Property="x => x.Numero" Title="Número" />
            <PropertyColumn Property="x => x.Serie" Title="Série" />
            <PropertyColumn Property="x => x.Emissao" Title="Emissão" />
            <PropertyColumn Property="x => x.Destinatario" Title="Destinatário" />
            <PropertyColumn Property="x => x.Valor" Title="Valor" />
            <TemplateColumn Title="Ações" Icon="@Icons.Material.Filled.MoreVert">
                <CellTemplate>
                    <MudMenu  
                        Icon="@Icons.Material.Filled.MoreVert"
                        ActivationEvent="@MouseEvent.MouseOver" 
                        AnchorOrigin="Origin.BottomCenter" 
                        TransformOrigin="Origin.TopCenter">
                        <ChildContent>
                            <MudMenuItem Icon="@Icons.Material.Filled.Print">Imprimir</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Archive">Arquivo XML</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Send">Enviar</MudMenuItem>
                            <MudMenuItem OnClick="ShowCancelConfirmation" Icon="@Icons.Material.Filled.DeleteForever">Cancelar</MudMenuItem>
                        </ChildContent>
                    </MudMenu>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="Documento" />
        </PagerContent>
    </MudDataGrid>
</MudContainer>

<MudMessageBox @ref="_mudMessageBox" Title="Atenção" CancelText="Desistir">
    <MessageContent>
        Tem certeza que deseja cancelar este documento? Esta ação não poderá ser desfeita.
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeleteForever">Cancelar</MudButton>
    </YesButton>
    <CancelButton>
        <MudButton Variant="Variant.Outlined">Desistir</MudButton>
    </CancelButton>
</MudMessageBox>

@code {
    private MudMessageBox _mudMessageBox;

    public string CNPJ_CPF { get; set; }
    private DateTime? _initialDate = DateTime.Today;
    private DateTime? _finalDate = DateTime.Today;

    bool _expanded = false;

    private void OnExpandCollapseClick() {
        _expanded = !_expanded;
    }


    private void ResetFilters()
    {
        _selectedStatuses.Clear();
        _selectedModels.Clear();
        ValorInicial = 0;
        ValorFinal = 0;
    }
    protected async Task ShowCancelConfirmation()
    {
        bool? result = await _mudMessageBox.ShowAsync();
        if (result == true)
        {
            // Lógica para cancelar o documento
            DocumentosList = DocumentosList.Where(d => d.Status != "Cancelado").ToList();
            // ApplyFilters(); // Se a lógica de cancelamento requer novos filtros, use aqui
        }
    }
}
