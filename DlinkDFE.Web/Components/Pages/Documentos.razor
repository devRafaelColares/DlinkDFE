@page "/documentos"

@using DlinkDFE.Web.Services
@using MudBlazor
@inject DocumentoService DocumentoService

<MudContainer Class="pa-8" Width="100%">
    <MudGrid>
        <MudGrid>
            <MudItem xs="8">
                <MudTextField 
                    @bind-Value="_searchString" 
                    Placeholder="Pesquisar..." 
                    Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.Search" 
                    Class="mt-0">
                </MudTextField>
            </MudItem>
            <MudItem xs="4" class="d-flex justify-end">
                <MudButton 
                    Variant="Variant.Filled" 
                    Color="Color.Primary" 
                    OnClick="ApplyFilters">Aplicar Filtros
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudDataGrid Class="pa-2"
            T="Documento" 
            Items="@FilteredDocumentos" 
            MultiSelection="true" 
            Filterable="true" 
            QuickFilter="@_quickFilter"
            SortMode="SortMode.Multiple"
            Style="width: 100%; table-layout: auto;">
            
            <Columns>
                <SelectColumn T="Documento" />
                <PropertyColumn Property="x => x.Status" Title="Status" />
                <PropertyColumn Property="x => x.Modelo" Title="Modelo" />
                <PropertyColumn Property="x => x.Numero" Title="Número" />
                <PropertyColumn Property="x => x.Serie" Title="Série" />
                <PropertyColumn Property="x => x.Emissao" Title="Emissão" />
                <PropertyColumn Property="x => x.Destinatario" Title="Destinatário" />
                <PropertyColumn Property="x => x.Valor" Title="Valor" />

                <TemplateColumn Title="Ações" Icon="@Icons.Material.Filled.MoreVert">
                    <CellTemplate>
                        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" 
                                    Color="Color.Primary" 
                                    @onclick="OnMoreVertClicked">
                        </MudIconButton>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="Documento" />
            </PagerContent>
        </MudDataGrid>
    </MudGrid>
</MudContainer>

@code {
    private IEnumerable<Documento> DocumentosList = new List<Documento>();
    private IEnumerable<Documento> FilteredDocumentos => DocumentosList.Where(_quickFilter);
    private string _searchString;

    private Func<Documento, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.Status.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.Numero.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.Destinatario.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    protected override Task OnInitializedAsync()
    {
        DocumentosList = DocumentoService.GetDocumentos();
        return Task.CompletedTask;
    }

    private void ApplyFilters()
    {
        StateHasChanged(); // Atualiza a UI para aplicar filtros
    }

    private void OnMoreVertClicked()
    {
        // Lógica ao clicar no ícone MoreVert
        Console.WriteLine("Ícone MoreVert clicado!");
    }
}
